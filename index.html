<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>MIDI Palette Uploader (Stable)</title>
    <style>
        body { font-family: sans-serif; padding: 20px; background: #f4f4f9; }
        .container { max-width: 600px; margin: auto; background: white; padding: 25px; border-radius: 10px; box-shadow: 0 2px 15px rgba(0,0,0,0.1); }
        h2 { color: #1a73e8; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        select, input, button { width: 100%; padding: 12px; margin-top: 10px; border-radius: 5px; border: 1px solid #ddd; box-sizing: border-box; }
        button { background: #1a73e8; color: white; font-weight: bold; border: none; cursor: pointer; }
        button:disabled { background: #ccc; }
        .log { margin-top: 20px; background: #222; color: #0f0; padding: 10px; border-radius: 5px; height: 150px; overflow-y: auto; font-family: monospace; font-size: 12px; }
        .dot-container { display: grid; grid-template-columns: repeat(16, 1fr); gap: 2px; margin-top: 10px; }
        .dot { aspect-ratio: 1; background: #000; border: 1px solid #333; }
    </style>
</head>
<body>

<div class="container">
    <h2>ğŸ¨ MIDI Palette Uploader</h2>
    
    <label>1. MIDI ì¶œë ¥ ì¥ì¹˜ ì„ íƒ</label>
    <select id="midi-select"><option>ì¥ì¹˜ë¥¼ ì°¾ëŠ” ì¤‘...</option></select>
    
    <label style="display:block; margin-top:15px;">2. ëŒ€ìƒ ì±„ë„ ì„ íƒ</label>
    <select id="target-idx">
        <option value="0">DAW CH 4 (Index 0)</option>
        <option value="1">DAW CH 5 (Index 1)</option>
        <option value="2">DAW CH 6 (Index 2)</option>
    </select>

    <label style="display:block; margin-top:15px;">3. íŒ”ë ˆíŠ¸ íŒŒì¼ ë¡œë“œ (.txt)</label>
    <input type="file" id="file-input" accept=".txt">
    
    <div id="dot-grid" class="dot-container"></div>

    <button id="send-btn" disabled style="margin-top:20px;">ESP32ë¡œ ë°ì´í„° ì „ì†¡</button>
    
    <div id="log-box" class="log">ë¡œê·¸ ëŒ€ê¸° ì¤‘...</div>
</div>

<script>
    let midiOut = null;
    let palette = { r: new Array(128).fill(0), g: new Array(128).fill(0), b: new Array(128).fill(0) };
    const logBox = document.getElementById('log-box');

    function log(msg) {
        const div = document.createElement('div');
        div.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
        logBox.appendChild(div);
        logBox.scrollTop = logBox.scrollHeight;
    }

    // 1. MIDI ì‹œìŠ¤í…œ ì‹œì‘ (Sysex ê¶Œí•œ í•„ìˆ˜ ìš”ì²­)
    if (navigator.requestMIDIAccess) {
        navigator.requestMIDIAccess({ sysex: true }).then(access => {
            const updateDevices = () => {
                const outputs = Array.from(access.outputs.values());
                const select = document.getElementById('midi-select');
                select.innerHTML = '';
                outputs.forEach(out => {
                    const opt = document.createElement('option');
                    opt.value = out.id;
                    opt.text = out.name;
                    select.appendChild(opt);
                });
                midiOut = outputs[0];
                document.getElementById('send-btn').disabled = !midiOut;
                if(midiOut) log(`ì¥ì¹˜ ì—°ê²°ë¨: ${midiOut.name}`);
            };
            access.onstatechange = updateDevices;
            updateDevices();
        }, () => alert("MIDI ì ‘ê·¼ ê±°ë¶€ë¨. HTTPS í™˜ê²½ì¸ì§€ í™•ì¸í•˜ì„¸ìš”."));
    }

    // 2. íŒŒì¼ íŒŒì‹± (4ë°° ë³´ì • í¬í•¨)
    document.getElementById('file-input').onchange = (e) => {
        const reader = new FileReader();
        reader.onload = () => {
            const lines = reader.result.split('\n');
            const grid = document.getElementById('dot-grid');
            grid.innerHTML = '';
            lines.forEach(line => {
                const m = line.match(/(\d+),\s*(\d+)\s+(\d+)\s+(\d+);/);
                if(m) {
                    const v = parseInt(m[1]);
                    palette.r[v] = Math.min(parseInt(m[2]) * 4, 255);
                    palette.g[v] = Math.min(parseInt(m[3]) * 4, 255);
                    palette.b[v] = Math.min(parseInt(m[4]) * 4, 255);
                }
            });
            for(let i=0; i<128; i++) {
                const d = document.createElement('div');
                d.className = 'dot';
                d.style.backgroundColor = `rgb(${palette.r[i]},${palette.g[i]},${palette.b[i]})`;
                grid.appendChild(d);
            }
            log("íŒŒì¼ íŒŒì‹± ì™„ë£Œ (4ë°° ë°ê¸° ë³´ì • ì ìš©)");
        };
        reader.readAsText(e.target.files[0]);
    };

    // 3. ì „ì†¡ í•¨ìˆ˜
    document.getElementById('send-btn').onclick = async () => {
        if(!midiOut) return;
        const target = parseInt(document.getElementById('target-idx').value);
        log(`ì „ì†¡ ì‹œì‘: Index ${target}...`);
        
        for(let type = 0; type < 3; type++) {
            const data = type === 0 ? palette.r : (type === 1 ? palette.g : palette.b);
            let enc = [];
            for(let i=0; i<128; i++) {
                enc.push((data[i] >> 7) & 0x01);
                enc.push(data[i] & 0x7F);
            }
            // ì „ì†¡
            midiOut.send([0xF0, 0x7D, target, type, ...enc, 0xF7]);
            log(`${type === 0 ? 'R' : type === 1 ? 'G' : 'B'} ì „ì†¡ ì™„ë£Œ`);
            await new Promise(r => setTimeout(r, 300)); // ESP32 ì²˜ë¦¬ ì‹œê°„ í™•ë³´
        }
        log("âœ… ëª¨ë“  ë°ì´í„° ì „ì†¡ ì™„ë£Œ!");
    };
</script>
</body>
</html>