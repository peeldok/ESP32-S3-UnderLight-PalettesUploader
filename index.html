<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>MIDI Palette Uploader (Stable v4)</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; padding: 30px; background: #f0f2f5; color: #333; }
        .container { max-width: 650px; margin: auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        h2 { margin-top: 0; color: #1a73e8; border-bottom: 2px solid #e8f0fe; padding-bottom: 10px; }
        label { display: block; font-weight: bold; margin-top: 15px; margin-bottom: 5px; font-size: 0.9em; }
        select, input, button { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; box-sizing: border-box; }
        button { background: #1a73e8; color: white; font-weight: bold; border: none; margin-top: 20px; cursor: pointer; transition: 0.2s; }
        button:hover { background: #1557b0; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .log { margin-top: 20px; background: #222; color: #0f0; padding: 15px; border-radius: 8px; height: 180px; overflow-y: auto; font-family: 'Consolas', monospace; font-size: 13px; }
        .grid { display: grid; grid-template-columns: repeat(16, 1fr); gap: 2px; margin-top: 10px; background: #ddd; border: 1px solid #ccc; }
        .dot { aspect-ratio: 1; background: #000; }
    </style>
</head>
<body>

<div class="container">
    <h2>ğŸ¨ MIDI Palette Uploader (v4)</h2>
    
    <label>1. MIDI ì¶œë ¥ ì¥ì¹˜ ì„ íƒ</label>
    <select id="midi-out-select"><option>ì¥ì¹˜ ê²€ìƒ‰ ì¤‘...</option></select>
    
    <label>2. ì—…ë¡œë“œ ëŒ€ìƒ (ì‚¬ìš©ì íŒ”ë ˆíŠ¸)</label>
    <select id="target-ch">
        <option value="0">User Palette 1 (CH 4)</option>
        <option value="1">User Palette 2 (CH 5)</option>
        <option value="2">User Palette 3 (CH 6)</option>
    </select>

    <label>3. íŒ”ë ˆíŠ¸ íŒŒì¼ ì„ íƒ (.txt)</label>
    <input type="file" id="file-input" accept=".txt">
    
    <div id="preview-grid" class="grid"></div>

    <button id="upload-btn" disabled>ESP32ë¡œ íŒ”ë ˆíŠ¸ ì „ì†¡ ì‹œì‘</button>
    
    <div id="log" class="log">íŒŒì¼ì„ ì„ íƒí•´ ì£¼ì„¸ìš”...</div>
</div>

<script>
    let midiOutput = null;
    let paletteData = { r: new Array(128).fill(0), g: new Array(128).fill(0), b: new Array(128).fill(0) };
    const logEl = document.getElementById('log');

    function addLog(msg) {
        const div = document.createElement('div');
        div.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
        logEl.appendChild(div);
        logEl.scrollTop = logEl.scrollHeight;
    }

    // MIDI ì„¤ì •
    if (navigator.requestMIDIAccess) {
        navigator.requestMIDIAccess({ sysex: true }).then(access => {
            const updateDevices = () => {
                const outputs = Array.from(access.outputs.values());
                const select = document.getElementById('midi-out-select');
                select.innerHTML = '';
                if (outputs.length === 0) {
                    select.innerHTML = '<option>ì¥ì¹˜ ì—†ìŒ</option>';
                    return;
                }
                outputs.forEach(out => {
                    const opt = document.createElement('option');
                    opt.value = out.id; opt.text = out.name;
                    select.appendChild(opt);
                });
                midiOutput = outputs[0];
                document.getElementById('upload-btn').disabled = false;
                addLog(`ì¥ì¹˜ ì¤€ë¹„ ì™„ë£Œ: ${midiOutput.name}`);
            };
            access.onstatechange = updateDevices;
            updateDevices();
        }, () => addLog("âŒ MIDI ì ‘ê·¼ ì‹¤íŒ¨ (HTTPS í™•ì¸)"));
    }

    // íŒŒì¼ ì½ê¸° ë¡œì§ (í•µì‹¬ ìˆ˜ì •)
    document.getElementById('file-input').onchange = (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = () => {
            const rawText = reader.result;
            const grid = document.getElementById('preview-grid');
            grid.innerHTML = '';
            
            // ë°ì´í„° ì´ˆê¸°í™”
            paletteData.r.fill(0); paletteData.g.fill(0); paletteData.b.fill(0);

            // [ìˆ˜ì •] ì •ê·œì‹ì„ ë” ìœ ì—°í•˜ê²Œ: ì¸ë±ìŠ¤ ë’¤ì— ì½¤ë§ˆê°€ ìˆê³ , ê·¸ ë’¤ì— ê³µë°±ìœ¼ë¡œ êµ¬ë¶„ëœ ìˆ«ì 3ê°œë¥¼ ì°¾ìŒ
            // ì˜ˆ: "72, 63 0 0;" ë˜ëŠ” "72, 63 0 0 \n" ëª¨ë‘ ëŒ€ì‘
            const regex = /(\d+),\s+(\d+)\s+(\d+)\s+(\d+)/g;
            let match;
            let foundCount = 0;

            while ((match = regex.exec(rawText)) !== null) {
                const idx = parseInt(match[1]);
                if (idx < 128) {
                    // Novation ê·œê²©(0-63) ëŒ€ì‘ 4ë°° ë³´ì •
                    paletteData.r[idx] = Math.min(parseInt(match[2]) * 4, 255);
                    paletteData.g[idx] = Math.min(parseInt(match[3]) * 4, 255);
                    paletteData.b[idx] = Math.min(parseInt(match[4]) * 4, 255);
                    foundCount++;
                }
            }

            // ê·¸ë¦¬ë“œ ì—…ë°ì´íŠ¸
            for (let i = 0; i < 128; i++) {
                const dot = document.createElement('div');
                dot.className = 'dot';
                dot.style.backgroundColor = `rgb(${paletteData.r[i]},${paletteData.g[i]},${paletteData.b[i]})`;
                grid.appendChild(dot);
            }

            if (foundCount > 0) {
                addLog(`âœ… ì„±ê³µ: ${foundCount}ê°œì˜ ìƒ‰ìƒ ë°ì´í„°ë¥¼ ì½ì—ˆìŠµë‹ˆë‹¤.`);
            } else {
                addLog(`âŒ ì˜¤ë¥˜: íŒŒì¼ í˜•ì‹ì´ ë§ì§€ ì•ŠìŠµë‹ˆë‹¤. (ë°ì´í„° 0ê°œ)`);
            }
        };
        reader.readAsText(file);
    };

    // ì „ì†¡ ë¡œì§
    document.getElementById('upload-btn').onclick = async () => {
        if (!midiOutput) return;
        const targetIdx = document.getElementById('target-ch').value;
        addLog(`ğŸš€ ì „ì†¡ ì‹œì‘... (ëŒ€ìƒ: User Palette ${parseInt(targetIdx)+1})`);

        for (let type = 0; type < 3; type++) {
            const data = type === 0 ? paletteData.r : (type === 1 ? paletteData.g : paletteData.b);
            let payload = [];
            for (let i = 0; i < 128; i++) {
                payload.push((data[i] >> 7) & 0x01); // MSB
                payload.push(data[i] & 0x7F);        // LSB
            }
            midiOutput.send([0xF0, 0x7D, parseInt(targetIdx), type, ...payload, 0xF7]);
            addLog(`${type === 0 ? 'ë¹¨ê°•' : type === 1 ? 'ì´ˆë¡' : 'íŒŒë‘'} ì™„ë£Œ`);
            await new Promise(r => setTimeout(r, 300));
        }
        addLog("âœ¨ ì „ì†¡ì´ ëª¨ë‘ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!");
    };
</script>
</body>
</html>
