<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>MIDI Palette Uploader (Stable v3 - Fixed)</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; padding: 30px; background: #f0f2f5; color: #333; }
        .container { max-width: 650px; margin: auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        h2 { margin-top: 0; color: #1a73e8; border-bottom: 2px solid #e8f0fe; padding-bottom: 10px; }
        label { display: block; font-weight: bold; margin-top: 15px; margin-bottom: 5px; font-size: 0.9em; }
        select, input, button { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; box-sizing: border-box; }
        button { background: #1a73e8; color: white; font-weight: bold; border: none; margin-top: 20px; cursor: pointer; transition: 0.2s; }
        button:hover { background: #1557b0; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .log { margin-top: 20px; background: #222; color: #0f0; padding: 15px; border-radius: 8px; height: 180px; overflow-y: auto; font-family: 'Consolas', monospace; font-size: 13px; }
        .grid { display: grid; grid-template-columns: repeat(16, 1fr); gap: 3px; margin-top: 10px; border: 1px solid #ddd; padding: 5px; background: #fafafa; }
        .dot { aspect-ratio: 1; background: #000; border-radius: 2px; }
    </style>
</head>
<body>

<div class="container">
    <h2>ğŸ¨ MIDI Palette Uploader (Fixed)</h2>
    
    <label>1. MIDI ì¶œë ¥ ì¥ì¹˜ ì„ íƒ (ESP32-S3)</label>
    <select id="midi-out-select"><option>ì¥ì¹˜ ê²€ìƒ‰ ì¤‘...</option></select>
    
    <label>2. ì—…ë¡œë“œ ëŒ€ìƒ ì±„ë„ (ESP32 íŒ”ë ˆíŠ¸ ì¸ë±ìŠ¤)</label>
    <select id="target-ch">
        <option value="0">User Palette 1 (CH 4)</option>
        <option value="1">User Palette 2 (CH 5)</option>
        <option value="2">User Palette 3 (CH 6)</option>
    </select>

    <label>3. íŒ”ë ˆíŠ¸ íŒŒì¼ ì„ íƒ (.txt)</label>
    <input type="file" id="file-input" accept=".txt">
    
    <label>ë¯¸ë¦¬ë³´ê¸° (128ìƒ‰)</label>
    <div id="preview-grid" class="grid"></div>

    <button id="upload-btn" disabled>ESP32ë¡œ íŒ”ë ˆíŠ¸ ì „ì†¡ ì‹œì‘</button>
    
    <div id="log" class="log">ëŒ€ê¸° ì¤‘...</div>
</div>

<script>
    let midiOutput = null;
    let paletteData = { r: new Array(128).fill(0), g: new Array(128).fill(0), b: new Array(128).fill(0) };
    const logEl = document.getElementById('log');

    function addLog(msg) {
        const div = document.createElement('div');
        div.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
        logEl.appendChild(div);
        logEl.scrollTop = logEl.scrollHeight;
    }

    if (navigator.requestMIDIAccess) {
        navigator.requestMIDIAccess({ sysex: true }).then(access => {
            const updateDevices = () => {
                const outputs = Array.from(access.outputs.values());
                const select = document.getElementById('midi-out-select');
                select.innerHTML = '';
                if (outputs.length === 0) {
                    select.innerHTML = '<option>ì¥ì¹˜ ì—†ìŒ</option>';
                    return;
                }
                outputs.forEach(out => {
                    const opt = document.createElement('option');
                    opt.value = out.id;
                    opt.text = out.name;
                    select.appendChild(opt);
                });
                midiOutput = outputs[0];
                document.getElementById('upload-btn').disabled = false;
                addLog(`ì¥ì¹˜ ì—°ê²°ë¨: ${midiOutput.name}`);
            };
            access.onstatechange = updateDevices;
            updateDevices();
        }, () => addLog("âŒ MIDI ì ‘ê·¼ì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤."));
    }

    // íŒŒì¼ ì½ê¸° ë¡œì§ ìˆ˜ì • (ë‹¤ì¤‘ ë°ì´í„° ë° 6ë¹„íŠ¸ ë³´ì • ì™„ë²½ ëŒ€ì‘)
    document.getElementById('file-input').onchange = (e) => {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = () => {
            const content = reader.result;
            const grid = document.getElementById('preview-grid');
            grid.innerHTML = '';
            
            // ëª¨ë“  ë°ì´í„°ë¥¼ ì´ˆê¸°í™” (ìƒˆ íŒŒì¼ ë¡œë“œ ì‹œ ë®ì–´ì“°ê¸° ìœ„í•´)
            paletteData.r.fill(0); paletteData.g.fill(0); paletteData.b.fill(0);

            // ì •ê·œì‹ ìˆ˜ì •: ì „ì—­ ê²€ìƒ‰(g)ì„ í†µí•´ í•œ ì¤„ ë‚´ì˜ ëª¨ë“  íŒ¨í„´ì„ ì°¾ì•„ëƒ„
            const regex = /(\d+),\s*(\d+)\s+(\d+)\s+(\d+)/g;
            let match;
            let count = 0;

            while ((match = regex.exec(content)) !== null) {
                const v = parseInt(match[1]); // ì¸ë±ìŠ¤ (0-127)
                if (v < 128) {
                    // 6ë¹„íŠ¸(0-63) ë°ì´í„°ì¸ì§€ í™•ì¸ í›„ 4ë°° ë³´ì •
                    let r = parseInt(match[2]);
                    let g = parseInt(match[3]);
                    let b = parseInt(match[4]);

                    // ë§Œì•½ íŒŒì¼ì˜ ëª¨ë“  ê°’ì´ 63 ì´í•˜ë¼ë©´ 4ë°° ì¦í­ ì ìš©
                    paletteData.r[v] = Math.min(r * 4, 255);
                    paletteData.g[v] = Math.min(g * 4, 255);
                    paletteData.b[v] = Math.min(b * 4, 255);
                    count++;
                }
            }

            // ê·¸ë¦¬ë“œ ì¬ìƒì„±
            for (let i = 0; i < 128; i++) {
                const dot = document.createElement('div');
                dot.className = 'dot';
                dot.style.backgroundColor = `rgb(${paletteData.r[i]},${paletteData.g[i]},${paletteData.b[i]})`;
                grid.appendChild(dot);
            }
            addLog(`ì´ ${count}ê°œì˜ ìƒ‰ìƒì„ ì½ì–´ì™”ìŠµë‹ˆë‹¤ (ë³´ì • ì™„ë£Œ).`);
        };
        reader.readAsText(file);
    };

    document.getElementById('upload-btn').onclick = async () => {
        if (!midiOutput) return;
        const targetIdx = parseInt(document.getElementById('target-ch').value);
        addLog(`ì „ì†¡ ì‹œì‘... (ëŒ€ìƒ ì¸ë±ìŠ¤: ${targetIdx})`);

        for (let type = 0; type < 3; type++) {
            const currentData = type === 0 ? paletteData.r : (type === 1 ? paletteData.g : paletteData.b);
            let payload = [];
            for (let i = 0; i < 128; i++) {
                payload.push((currentData[i] >> 7) & 0x01); // 7ë¹„íŠ¸ ìƒìœ„
                payload.push(currentData[i] & 0x7F);        // 7ë¹„íŠ¸ í•˜ìœ„
            }
            midiOutput.send([0xF0, 0x7D, targetIdx, type, ...payload, 0xF7]);
            addLog(`${type === 0 ? 'RED' : type === 1 ? 'GREEN' : 'BLUE'} ë°ì´í„° ì „ì†¡ë¨`);
            await new Promise(r => setTimeout(r, 400));
        }
        addLog("âœ… ëª¨ë“  íŒ”ë ˆíŠ¸ ì „ì†¡ ë° ë®ì–´ì“°ê¸° ì™„ë£Œ!");
    };
</script>
</body>
</html>
