<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>MIDI Palette Uploader</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; padding: 30px; background: #f0f2f5; color: #333; }
        .container { max-width: 650px; margin: auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        h2 { margin-top: 0; color: #1a73e8; border-bottom: 2px solid #e8f0fe; padding-bottom: 10px; }
        label { display: block; font-weight: bold; margin-top: 15px; margin-bottom: 5px; font-size: 0.9em; }
        select, button { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; box-sizing: border-box; }
        
        .file-upload-wrapper { position: relative; width: 100%; }
        #file-input { display: none; }
        .custom-file-upload {
            display: block;
            width: 100%;
            padding: 12px;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            box-sizing: border-box;
            color: #666;
            transition: 0.2s;
        }
        .custom-file-upload:hover { background: #f8f9fa; border-color: #1a73e8; color: #1a73e8; }
        
        button { background: #1a73e8; color: white; font-weight: bold; border: none; margin-top: 20px; cursor: pointer; transition: 0.2s; }
        button:hover { background: #1557b0; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        
        .grid { display: grid; grid-template-columns: repeat(16, 1fr); gap: 2px; margin-top: 10px; background: #ddd; border: 1px solid #ccc; }
        .dot { aspect-ratio: 1; background: #000; }
    </style>
</head>
<body>

<div class="container">
    <h2>ðŸŽ¨ MIDI Palette Uploader</h2>
    
    <label>1. Select MIDI Output Device</label>
    <select id="midi-out-select"><option>Scanning for devices...</option></select>
    
    <label>2. Upload Target</label>
    <select id="target-ch">
        <option value="0">User Palette 1 (CH 4)</option>
        <option value="1">User Palette 2 (CH 5)</option>
        <option value="2">User Palette 3 (CH 6)</option>
    </select>

    <label>3. Select Palette File</label>
    <div class="file-upload-wrapper">
        <label for="file-input" class="custom-file-upload" id="file-label">
            Click to choose a file...
        </label>
        <input type="file" id="file-input">
    </div>
    
    <div id="preview-grid" class="grid"></div>

    <button id="upload-btn" disabled>Start Upload</button>
</div>

<script>
    let midiOutput = null;
    let paletteData = { r: new Array(128).fill(0), g: new Array(128).fill(0), b: new Array(128).fill(0) };

    // MIDI Setup
    if (navigator.requestMIDIAccess) {
        navigator.requestMIDIAccess({ sysex: true }).then(access => {
            const updateDevices = () => {
                const outputs = Array.from(access.outputs.values());
                const select = document.getElementById('midi-out-select');
                select.innerHTML = '';
                if (outputs.length === 0) {
                    select.innerHTML = '<option>No devices found</option>';
                    return;
                }
                outputs.forEach(out => {
                    const opt = document.createElement('option');
                    opt.value = out.id; opt.text = out.name;
                    select.appendChild(opt);
                });
                midiOutput = outputs[0];
                document.getElementById('upload-btn').disabled = false;
            };
            access.onstatechange = updateDevices;
            updateDevices();
        });
    }

    // File Loading Logic
    document.getElementById('file-input').onchange = (e) => {
        const file = e.target.files[0];
        if (!file) return;

        document.getElementById('file-label').textContent = `Selected: ${file.name}`;

        const reader = new FileReader();
        reader.onload = () => {
            const rawText = reader.result;
            const grid = document.getElementById('preview-grid');
            grid.innerHTML = '';
            
            paletteData.r.fill(0); paletteData.g.fill(0); paletteData.b.fill(0);

            const regex = /(\d+),\s+(\d+)\s+(\d+)\s+(\d+)/g;
            let match;

            while ((match = regex.exec(rawText)) !== null) {
                const idx = parseInt(match[1]);
                if (idx < 128) {
                    paletteData.r[idx] = Math.min(parseInt(match[2]) * 4, 255);
                    paletteData.g[idx] = Math.min(parseInt(match[3]) * 4, 255);
                    paletteData.b[idx] = Math.min(parseInt(match[4]) * 4, 255);
                }
            }

            for (let i = 0; i < 128; i++) {
                const dot = document.createElement('div');
                dot.className = 'dot';
                dot.style.backgroundColor = `rgb(${paletteData.r[i]},${paletteData.g[i]},${paletteData.b[i]})`;
                grid.appendChild(dot);
            }
        };
        reader.readAsText(file);
    };

    // Upload Logic
    document.getElementById('upload-btn').onclick = async () => {
        if (!midiOutput) return;
        
        const btn = document.getElementById('upload-btn');
        const originalText = btn.textContent;
        const targetIdx = document.getElementById('target-ch').value;

        btn.disabled = true;
        btn.textContent = "Uploading...";

        for (let type = 0; type < 3; type++) {
            const data = type === 0 ? paletteData.r : (type === 1 ? paletteData.g : paletteData.b);
            let payload = [];
            for (let i = 0; i < 128; i++) {
                payload.push((data[i] >> 7) & 0x01);
                payload.push(data[i] & 0x7F);
            }
            midiOutput.send([0xF0, 0x7D, parseInt(targetIdx), type, ...payload, 0xF7]);
            await new Promise(r => setTimeout(r, 300));
        }

        btn.disabled = false;
        btn.textContent = "Upload Complete!";
        setTimeout(() => { btn.textContent = originalText; }, 2000);
    };
</script>
</body>
</html>
